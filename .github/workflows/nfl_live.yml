name: NFL live fourth down bot

on:
  schedule:
    # Regular Sunday slates (Weeks 12-17)
    - cron: "*/10 17-23 * * 0"  # Sundays 11:00-17:59 CT (17-23 UTC)
    - cron: "*/10 0-6 * * 1"    # Sunday nights 18:00-23:59 CT (0-6 UTC Monday)

    # Monday Night Football (Weeks 12-17)
    - cron: "*/10 0-6 * * 2"    # Tuesday 0-6 UTC -> Monday evening CT

    # Thursday Night Football (Weeks 13-16)
    - cron: "*/10 0-6 * * 5"    # Friday 0-6 UTC -> Thursday evening CT

    # Thanksgiving triple header (Thu Nov 27 2025)
    - cron: "*/10 17-23 * 11 4" # Thursdays in November, 11:00-17:59 CT (17-23 UTC)
    - cron: "*/10 0-6 * 11 5"   # Early Friday UTC for late Thanksgiving game

    # Black Friday game (Fri Nov 28 2025)
    - cron: "*/10 17-23 * 11 5" # Fridays in November, 11:00-17:59 CT (17-23 UTC)

    # December Saturday games
    - cron: "*/10 17-23 * 12 6" # Saturdays in December, 11:00-17:59 CT (17-23 UTC)
    - cron: "*/10 0-6 * 12 0"   # Early Sunday UTC for late Saturday games

    # Christmas triple header (Thu Dec 25 2025)
    - cron: "*/10 17-23 25 12 *" # Dec 25, 11:00-17:59 CT (17-23 UTC)
    - cron: "*/10 0-6 26 12 *"   # Early hours after Christmas games

  workflow_dispatch:

jobs:
  run-live-today:
    runs-on: ubuntu-latest

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      TZ: America/Chicago

      # Control polling behavior inside run_live_today()
      QUICK_POLL_COUNT: 1
      POLL_SECONDS: 20

      # Uncomment and set these if posting happens in the called scripts
      # BLUESKY_HANDLE: ${{ secrets.BLUESKY_HANDLE }}
      # BLUESKY_APP_PASSWORD: ${{ secrets.BLUESKY_APP_PASSWORD }}
      # MASTODON_TOKEN: ${{ secrets.MASTODON_TOKEN }}
      # MASTO_SERVER: ${{ secrets.MASTO_SERVER }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: "4.4.2"
          use-public-rspm: true

      - name: Install and cache R package dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          cache-version: 1
          extra-packages: |
            any::curl
            any::httr
            any::jsonlite
            any::dplyr
            any::purrr
            any::lubridate
            any::glue
            any::readr
            any::tibble
            any::stringr
            any::data.table

      - name: Sanity check libraries
        run: |
          Rscript -e "print(.libPaths());
                      pkgs <- c('curl','httr','jsonlite','dplyr');
                      cat('Package locations:\n');
                      for (p in pkgs) cat(p, '->', system.file(package = p), '\n')"

      - name: Run live today wrapper
        run: |
          Rscript --vanilla R/bots/run_live_today.R

      - name: Check for output files
        if: always()
        run: |
          if [ -d "R/bots/live_csv" ]; then
            echo "=== Output files ===" 
            ls -lh R/bots/live_csv/
            echo "=== Latest log ===" 
            tail -20 $(ls -t R/bots/live_csv/*.log 2>/dev/null | head -1) 2>/dev/null || echo "No logs yet"
            echo "=== Latest CSV (first 10 rows) ===" 
            head -10 $(ls -t R/bots/live_csv/*.csv 2>/dev/null | head -1) 2>/dev/null || echo "No CSVs yet"
          else
            echo "No output directory created"
          fi

