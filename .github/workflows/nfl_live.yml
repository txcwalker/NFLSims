name: NFL live fourth down bot

on:
  schedule:
    # ------------------------------------------------------------
    # Regular Sunday slates (Weeks 12-17)
    # All remaining Sundays have noon CT / 1 ET early games,
    # late afternoon games, and most have SNF at 8:20 ET.
    # Window: roughly 11:00 to 24:00 Central.
    # This is 17:00 to 06:00 UTC (next day).
    # ------------------------------------------------------------
    - cron: "*/10 17-23 * * 0"  # Sundays 11:00-17:59 CT
    - cron: "*/10 0-6 * * 1"    # Sunday nights 18:00-23:59 CT

    # ------------------------------------------------------------
    # Monday Night Football (Weeks 12-17)
    # All remaining MNF games kick at 8:15 ET (7:15 CT).
    # We cover Monday evening 18:00-23:59 CT,
    # which is 00:00-06:00 UTC Tuesday.
    # ------------------------------------------------------------
    - cron: "*/10 0-6 * * 2"    # Tuesday 00:00-06:59 UTC -> Monday evening CT

    # ------------------------------------------------------------
    # Thursday Night Football (Weeks 13-16)
    # All remaining TNF games kick around 8:15 ET (7:15 CT).
    # Same idea: cover Thursday evening 18:00-23:59 CT,
    # which is 00:00-06:00 UTC Friday.
    # ------------------------------------------------------------
    - cron: "*/10 0-6 * * 5"    # Friday 00:00-06:59 UTC -> Thursday evening CT

    # ------------------------------------------------------------
    # Thanksgiving triple-header (Thu Nov 27)
    # Early game 1:00 ET (12:00 CT), second at 3:30 CT,
    # night game 8:20 ET (7:20 CT).
    # Cover Thursday from 11:00-23:59 CT and the night game spillover.
    # ------------------------------------------------------------
    - cron: "*/10 17-23 * 11 4" # All November Thursdays 11:00-17:59 CT (17-23 UTC)
    - cron: "*/10 0-6 * 11 5"   # Early Friday UTC to catch late Thanksgiving game

    # ------------------------------------------------------------
    # Black Friday game (Fri Nov 28)
    # Bears at Eagles at 3:00 ET (2:00 CT).
    # Cover Friday afternoon/evening in November.
    # ------------------------------------------------------------
    - cron: "*/10 17-23 * 11 5" # All November Fridays 11:00-17:59 CT (17-23 UTC)

    # ------------------------------------------------------------
    # December Saturday games
    # Week 16: Sat Dec 20, two TBD FOX games.
    # Week 17: Sat Dec 27, five TBD games.
    # These will be afternoon or evening local, so:
    # cover Saturdays 11:00-23:59 CT and early overnight.
    # ------------------------------------------------------------
    - cron: "*/10 17-23 * 12 6" # All December Saturdays 11:00-17:59 CT (17-23 UTC)
    - cron: "*/10 0-6 * 12 0"   # Early Sunday UTC to catch late Saturday games

    # ------------------------------------------------------------
    # Christmas triple-header (Thu Dec 25)
    # 1:00 ET, 4:30 ET, 8:15 ET
    # Cover afternoon and evening CT plus spillover.
    # ------------------------------------------------------------
    - cron: "*/10 17-23 25 12 *" # Dec 25, 11:00-17:59 CT (17-23 UTC)
    - cron: "*/10 0-6 26 12 *"   # Early hours after Christmas games

  workflow_dispatch:

jobs:
  run-live-today:
    runs-on: ubuntu-latest

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      TZ: America/Chicago

      QUICK_POLL_COUNT: 1
      POLL_SECONDS: 20

      # Posting secrets if needed by downstream scripts:
      # BLUESKY_HANDLE: ${{ secrets.BLUESKY_HANDLE }}
      # BLUESKY_APP_PASSWORD: ${{ secrets.BLUESKY_APP_PASSWORD }}
      # MASTODON_TOKEN: ${{ secrets.MASTODON_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: "4.4.2"

      - name: Install system libraries for curl and SSL
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev

      - name: Install R package dependencies
        run: |
          Rscript -e "options(repos=c(CRAN='https://cloud.r-project.org'));
                      needed <- c('curl','httr','jsonlite','dplyr','purrr','lubridate','glue','readr','tibble');
                      inst <- setdiff(needed, rownames(installed.packages()));
                      if(length(inst)) install.packages(inst)"

      - name: Sanity check libraries
        run: |
          Rscript -e 'print(.libPaths())' \
                  -e 'pkgs <- c("curl","httr"); \
                      cat("Package locations:\n"); \
                      for (p in pkgs) cat(p, "->", system.file(package = p), "\n")'

      - name: Run live today wrapper
        run: |
          Rscript --vanilla R/bots/run_live_today.R
